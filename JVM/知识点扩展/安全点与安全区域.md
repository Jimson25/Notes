# 安全点与安全区域

1. 安全点
    - 在java中, 程序并不是在任意位置都能开始GC,只有在特殊的位置点上才能执行GC,这些位置点称为`安全点(SafePoint)`

    - 安全点的选择是很重要的,太少可能导致GC等待时间过长,太多则可能导致运行时的性能问题. 大部分指令的执行时间都很短暂,通常会根据`"是否具有让程序长时间执行的特征"`为依据.比如选择一些执行时间较长的指令作为安全点,如`方法调用、循环跳转和异常跳转`等.
    
    - 线程中断方式
        - 抢先式中断: 先中断所有线程, 如果存在线程不在安全点上,就恢复线程让其跑到安全点再停止. (目前已经没有虚拟机采用这种方式)
        - 主动式中断: 设置一个中断标志,各线程执行到安全点的时候主动轮询这个标志,如果中断标志为真,则将自己进行中断挂起.

2. 安全区域
    - 安全点机制保证了线程在执行中的不太长的时间内就可以进入到GC状态. 但是程序中线程可能会处于一个`阻塞的状态`,那么此时该线程就无法满足JVM的中断请求运行到安全点挂起,那么在这种情况下就需要为线程`设置安全区域`来解决这个问题.

    - 安全区域是指`在一段代码片段中,对象的引用关系不会发生变化,在这个区域中的任何位置开始GC都是安全的`.一般可以把安全区域看作是安全点的扩展.

    - 在实际执行中,当线程运行到安全区域代码时,首先会标识该线程已进入安全区域,如果在这段时间内发生GC, JVM会忽略安全点标识.

    - 当线程即将离开安全区域时,会检查JVM是否已经完成GC, 如果已经完成,则线程继续执行,否则必须等待直到接收到可以安全离开安全区域的信号为止.
